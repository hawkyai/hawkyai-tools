name: Deploy to Labs

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: acrhawkyai
  RESOURCE_GROUP: rg-hawkyai-staging
  CONTAINER_APP_NAME: ca-hawkyai-labs
  CONTAINER_APP_ENV: cae-hawkyai-staging
  IMAGE_NAME: hawkyai-labs
  KV_NAME: kvhawkyai
  SUBSCRIPTION_ID: 192d2bcd-429c-42f5-811b-48a95f8c506f
  CUSTOM_DOMAIN: labs.hawky.ai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸŽ¯ Set Azure Subscription
      run: |
        az account set --subscription $SUBSCRIPTION_ID
        az account show
        echo "âœ… Subscription set to: $SUBSCRIPTION_ID"
    
    - name: ðŸ³ Build and push to ACR
      run: |
        az acr build \
          --registry $ACR_NAME \
          --image $IMAGE_NAME:${{ github.sha }} \
          --image $IMAGE_NAME:latest \
          --file Dockerfile \
          .
    
    - name: ðŸš€ Create Container App (first deployment)
      continue-on-error: true
      run: |
        az containerapp create \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --environment $CONTAINER_APP_ENV \
          --image $ACR_NAME.azurecr.io/$IMAGE_NAME:latest \
          --target-port 3000 \
          --ingress external \
          --registry-server $ACR_NAME.azurecr.io \
          --registry-username acrhawkyai \
          --registry-password "${{ secrets.ACR_PASSWORD }}" \
          --cpu 1.0 \
          --memory 2.0Gi \
          --min-replicas 2 \
          --max-replicas 5 \
          --env-vars \
            "NODE_ENV=production" \
            "MONGODB_DB=hawkyai" \
            "AWS_REGION=ap-south-1" \
            "AWS_S3_BUCKET=hawky-ai-static-tryout" \
            "ELASTICSEARCH_CLOUD_ID=h-staging-ES:Y2VudHJhbGluZGlhLmF6dXJlLmVsYXN0aWMtY2xvdWQuY29tOjkyNDMkYjA5NWRmNDQ1OWQxNGUwMWI3MjMwMDU3ZjkwNTNhZTYkMmYzNjJkZTkyNWRjNDAzMGJiODU5NzFmNGFkZDA0ODQ=" \
            "ELASTICSEARCH_IMAGE_INDEX=image_competitors_analysis" \
            "ELASTICSEARCH_VIDEO_INDEX=video_competitors_analysis" \
            "EMAIL_FROM=hawky.ai@gmail.com" \
            "EMAIL_SERVER_HOST=smtp.example.com" \
            "EMAIL_SERVER_PORT=587" \
            "EMAIL_SERVER_USER=hawky.ai@gmail.com" \
            "GOOGLE_CLIENT_ID=896125824463-ru2dhbl8mtscj928kagc8346cl681k0b.apps.googleusercontent.com" \
            "NEXTAUTH_URL=https://$CUSTOM_DOMAIN"
    
    - name: ðŸ” Enable Managed Identity
      run: |
        echo "Ensuring Container App has system-assigned managed identity..."
        az containerapp identity assign \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --system-assigned \
          2>&1 | tee /tmp/identity-output.log || true
        
        if grep -qi "already exists\|succeeded" /tmp/identity-output.log || [ $? -eq 0 ]; then
          echo "âœ… Managed identity is enabled"
        else
          echo "âš ï¸ Retrying identity assignment..."
          sleep 5
          az containerapp identity assign \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --system-assigned
        fi
    
    - name: ðŸ” Get Managed Identity Principal ID
      id: get-identity
      run: |
        echo "Retrieving Container App managed identity..."
        
        # Try to get the principal ID
        PRINCIPAL_ID=$(az containerapp identity show \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query principalId -o tsv 2>/dev/null)
        
        # If empty, wait and retry
        if [ -z "$PRINCIPAL_ID" ]; then
          echo "â³ Principal ID not immediately available, waiting 10 seconds..."
          sleep 10
          
          PRINCIPAL_ID=$(az containerapp identity show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --query principalId -o tsv)
        fi
        
        # Verify we got it
        if [ -z "$PRINCIPAL_ID" ]; then
          echo "âŒ CRITICAL ERROR: Cannot retrieve Principal ID after retry"
          echo "This usually means the managed identity wasn't created properly"
          exit 1
        fi
        
        echo "âœ… Container App Managed Identity Principal ID: $PRINCIPAL_ID"
        echo "PRINCIPAL_ID=$PRINCIPAL_ID" >> $GITHUB_OUTPUT
    
    - name: ðŸ”‘ Grant Key Vault Access (RBAC)
      run: |
        PRINCIPAL_ID="${{ steps.get-identity.outputs.PRINCIPAL_ID }}"
        
        echo "================================================"
        echo "Granting Key Vault Access via RBAC"
        echo "================================================"
        echo ""
        echo "Container App Managed Identity: $PRINCIPAL_ID"
        echo "Key Vault: $KV_NAME"
        echo "Role: Key Vault Secrets User"
        echo ""
        
        # Get Key Vault resource ID
        KV_ID=$(az keyvault show \
          --name $KV_NAME \
          --query id -o tsv)
        
        echo "Key Vault Resource ID: $KV_ID"
        echo ""
        
        # Assign the RBAC role
        echo "Assigning role (this will show an error if it already exists - that's OK)..."
        az role assignment create \
          --role "Key Vault Secrets User" \
          --assignee-object-id $PRINCIPAL_ID \
          --assignee-principal-type ServicePrincipal \
          --scope $KV_ID \
          2>&1 | tee /tmp/role-output.log || true
        
        # Check if it succeeded or already exists
        if grep -qi "already exists\|conflict" /tmp/role-output.log; then
          echo "âœ… Role assignment already exists"
        elif grep -qi "created\|succeeded" /tmp/role-output.log; then
          echo "âœ… Role assignment created successfully"
        else
          echo "âš ï¸ Role assignment output:"
          cat /tmp/role-output.log
          echo ""
          echo "Continuing anyway - will verify in next step"
        fi
        
        echo ""
        echo "âœ… RBAC role assignment step completed"
    
    - name: â³ Wait for RBAC Permission Propagation
      run: |
        echo "================================================"
        echo "Waiting for Azure RBAC Permissions to Propagate"
        echo "================================================"
        echo ""
        echo "Why this is necessary:"
        echo "  - RBAC permissions are not instant"
        echo "  - Azure AD needs time to sync the role assignments"
        echo "  - This typically takes 1-3 minutes"
        echo "  - We wait 120 seconds to be safe"
        echo ""
        
        WAIT_TIME=120
        echo "Starting ${WAIT_TIME}-second wait..."
        
        for i in $(seq $WAIT_TIME -1 1); do
          # Show progress every 15 seconds
          if [ $((i % 15)) -eq 0 ] || [ $i -le 5 ]; then
            echo "  â±ï¸  $i seconds remaining..."
          fi
          sleep 1
        done
        
        echo ""
        echo "âœ… Wait complete - RBAC permissions should now be active"
    
    - name: ðŸ” Configure Container App Secrets
      run: |
        echo "================================================"
        echo "Configuring Container App Secrets"
        echo "================================================"
        echo ""
        echo "Setting up Key Vault references for all secrets..."
        echo "The Container App will fetch actual secret values at runtime"
        echo "using its managed identity."
        echo ""
        
        az containerapp secret set \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --secrets \
            mongodb-uri=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/MONGODB-URI,identityref:system \
            aws-access-key-id=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/AWS-ACCESS-KEY-ID,identityref:system \
            aws-secret-access-key=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/AWS-SECRET-ACCESS-KEY,identityref:system \
            elasticsearch-api-key=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ELASTICSEARCH-API-KEY,identityref:system \
            google-client-secret=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/GOOGLE-CLIENT-SECRET,identityref:system \
            nextauth-secret=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/NEXTAUTH-SECRET,identityref:system \
            resend-api-key=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/RESEND-API-KEY,identityref:system \
            email-server-password=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/EMAIL-SERVER-PASSWORD,identityref:system \
            slack-error-webhook-url=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/SLACK-ERROR-WEBHOOK-URL,identityref:system \
            slack-webhook-url=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/SLACK-WEBHOOK-URL,identityref:system \
            vercel-oidc-token=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/VERCEL-OIDC-TOKEN,identityref:system \
            zoho-access-token=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-ACCESS-TOKEN,identityref:system \
            zoho-client-id=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-CLIENT-ID,identityref:system \
            zoho-client-secret=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-CLIENT-SECRET,identityref:system \
            zoho-refresh-token=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-REFRESH-TOKEN,identityref:system
        
        echo ""
        echo "âœ… All 15 secrets configured with Key Vault references"
    
    - name: ðŸ”„ Update Container App
      run: |
        echo "Updating Container App with new image and environment variables..."
        
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} \
          --set-env-vars \
            "MONGODB_URI=secretref:mongodb-uri" \
            "AWS_ACCESS_KEY_ID=secretref:aws-access-key-id" \
            "AWS_SECRET_ACCESS_KEY=secretref:aws-secret-access-key" \
            "ELASTICSEARCH_API_KEY=secretref:elasticsearch-api-key" \
            "GOOGLE_CLIENT_SECRET=secretref:google-client-secret" \
            "NEXTAUTH_SECRET=secretref:nextauth-secret" \
            "RESEND_API_KEY=secretref:resend-api-key" \
            "EMAIL_SERVER_PASSWORD=secretref:email-server-password" \
            "SLACK_ERROR_WEBHOOK_URL=secretref:slack-error-webhook-url" \
            "SLACK_WEBHOOK_URL=secretref:slack-webhook-url" \
            "VERCEL_OIDC_TOKEN=secretref:vercel-oidc-token" \
            "ZOHO_ACCESS_TOKEN=secretref:zoho-access-token" \
            "ZOHO_CLIENT_ID=secretref:zoho-client-id" \
            "ZOHO_CLIENT_SECRET=secretref:zoho-client-secret" \
            "ZOHO_REFRESH_TOKEN=secretref:zoho-refresh-token" \
            "NEXTAUTH_URL=https://$CUSTOM_DOMAIN"
        
        echo "âœ… Container App updated successfully"
    
    - name: ðŸ”€ Enable Multiple Revisions
      run: |
        az containerapp revision set-mode \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --mode multiple
    
    - name: ðŸŒ Configure Custom Domain
      run: |
        DOMAIN_EXISTS=$(az containerapp hostname list \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query "[?name=='$CUSTOM_DOMAIN'].name" -o tsv)
        
        if [ -z "$DOMAIN_EXISTS" ]; then
          echo "âž• Adding custom domain: $CUSTOM_DOMAIN"
          az containerapp hostname add \
            --hostname $CUSTOM_DOMAIN \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP
          
          az containerapp hostname bind \
            --hostname $CUSTOM_DOMAIN \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --environment $CONTAINER_APP_ENV \
            --validation-method CNAME
        else
          echo "âœ… Custom domain already configured"
        fi
    
    - name: âœ… Deployment Summary
      run: |
        PRINCIPAL_ID="${{ steps.get-identity.outputs.PRINCIPAL_ID }}"
        
        echo "### ðŸŽ‰ Labs Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Labs" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** [labs.hawky.ai](https://$CUSTOM_DOMAIN)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`$ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Security:**" >> $GITHUB_STEP_SUMMARY
        echo "- Key Vault: \`kvhawkyai\` (RBAC mode)" >> $GITHUB_STEP_SUMMARY
        echo "- Managed Identity: \`$PRINCIPAL_ID\`" >> $GITHUB_STEP_SUMMARY
        echo "- Role: Key Vault Secrets User" >> $GITHUB_STEP_SUMMARY
        echo "- Secrets: 15 secrets referenced from Key Vault" >> $GITHUB_STEP_SUMMARY