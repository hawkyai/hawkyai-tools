name: Deploy to Labs

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: acrhawkyai
  RESOURCE_GROUP: rg-hawkyai-staging
  CONTAINER_APP_NAME: ca-hawkyai-labs
  CONTAINER_APP_ENV: cae-hawkyai-staging
  IMAGE_NAME: hawkyai-labs
  SUBSCRIPTION_ID: 192d2bcd-429c-42f5-811b-48a95f8c506f
  CUSTOM_DOMAIN: labs.hawky.ai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸŽ¯ Set Azure Subscription
      run: |
        az account set --subscription $SUBSCRIPTION_ID
        az account show
        echo "âœ… Subscription set to: $SUBSCRIPTION_ID"
    
    - name: ðŸ³ Build and push to ACR
      run: |
        az acr build \
          --registry $ACR_NAME \
          --image $IMAGE_NAME:${{ github.sha }} \
          --image $IMAGE_NAME:latest \
          --file Dockerfile \
          .
    
    - name: ðŸ”‘ Get ACR Credentials
      id: acr-creds
      run: |
        ACR_USERNAME=$(az acr credential show \
          --name $ACR_NAME \
          --query username -o tsv)
        
        ACR_PASSWORD=$(az acr credential show \
          --name $ACR_NAME \
          --query "passwords[0].value" -o tsv)
        
        echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "::add-mask::$ACR_PASSWORD"
        echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_OUTPUT
        
        echo "âœ… Retrieved ACR credentials"
    
    - name: ðŸš€ Update Container App
      run: |
        echo "Updating Container App with new image..."
        echo "NOTE: This assumes secrets are already configured in Azure Portal"
        echo ""
        
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}
        
        echo "âœ… Container App updated with new image"
    
    - name: ðŸ”€ Enable Multiple Revisions
      run: |
        az containerapp revision set-mode \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --mode multiple
    
    - name: ðŸŒ Configure Custom Domain
      run: |
        DOMAIN_EXISTS=$(az containerapp hostname list \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query "[?name=='$CUSTOM_DOMAIN'].name" -o tsv)
        
        if [ -z "$DOMAIN_EXISTS" ]; then
          echo "âž• Adding custom domain: $CUSTOM_DOMAIN"
          az containerapp hostname add \
            --hostname $CUSTOM_DOMAIN \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP
          
          az containerapp hostname bind \
            --hostname $CUSTOM_DOMAIN \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --environment $CONTAINER_APP_ENV \
            --validation-method CNAME
        else
          echo "âœ… Custom domain already configured"
        fi
    
    - name: âœ… Deployment Summary
      run: |
        echo "### ðŸŽ‰ Labs Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Labs" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** [labs.hawky.ai](https://$CUSTOM_DOMAIN)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`$ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Secrets are managed manually in Azure Portal" >> $GITHUB_STEP_SUMMARY