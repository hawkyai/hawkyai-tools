name: Deploy to Labs

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: acrhawkyai
  RESOURCE_GROUP: rg-hawkyai-staging
  CONTAINER_APP_NAME: ca-hawkyai-labs
  CONTAINER_APP_ENV: cae-hawkyai-staging
  IMAGE_NAME: hawkyai-labs
  KV_NAME: kvhawkyai
  SUBSCRIPTION_ID: 192d2bcd-429c-42f5-811b-48a95f8c506f
  CUSTOM_DOMAIN: labs.hawky.ai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3
    
    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: üéØ Set Azure Subscription
      run: |
        az account set --subscription $SUBSCRIPTION_ID
        az account show
        echo "‚úÖ Subscription set to: $SUBSCRIPTION_ID"
    
    - name: üê≥ Build and push to ACR
      run: |
        az acr build \
          --registry $ACR_NAME \
          --image $IMAGE_NAME:${{ github.sha }} \
          --image $IMAGE_NAME:latest \
          --file Dockerfile \
          .
    
    - name: üîë Get ACR Credentials
      id: acr-creds
      run: |
        # Get ACR admin credentials
        ACR_USERNAME=$(az acr credential show \
          --name $ACR_NAME \
          --query username -o tsv)
        
        ACR_PASSWORD=$(az acr credential show \
          --name $ACR_NAME \
          --query "passwords[0].value" -o tsv)
        
        echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "::add-mask::$ACR_PASSWORD"
        echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Retrieved ACR credentials"
    
    - name: üöÄ Create Container App (first deployment)
      continue-on-error: true
      run: |
        az containerapp create \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --environment $CONTAINER_APP_ENV \
          --image $ACR_NAME.azurecr.io/$IMAGE_NAME:latest \
          --target-port 3000 \
          --ingress external \
          --registry-server $ACR_NAME.azurecr.io \
          --registry-username "${{ steps.acr-creds.outputs.ACR_USERNAME }}" \
          --registry-password "${{ steps.acr-creds.outputs.ACR_PASSWORD }}" \
          --cpu 1.0 \
          --memory 2.0Gi \
          --min-replicas 2 \
          --max-replicas 5 \
          --env-vars \
            "NODE_ENV=production" \
            "MONGODB_DB=hawkyai" \
            "AWS_REGION=ap-south-1" \
            "AWS_S3_BUCKET=hawky-ai-static-tryout" \
            "ELASTICSEARCH_CLOUD_ID=h-staging-ES:Y2VudHJhbGluZGlhLmF6dXJlLmVsYXN0aWMtY2xvdWQuY29tOjkyNDMkYjA5NWRmNDQ1OWQxNGUwMWI3MjMwMDU3ZjkwNTNhZTYkMmYzNjJkZTkyNWRjNDAzMGJiODU5NzFmNGFkZDA0ODQ=" \
            "ELASTICSEARCH_IMAGE_INDEX=image_competitors_analysis" \
            "ELASTICSEARCH_VIDEO_INDEX=video_competitors_analysis" \
            "EMAIL_FROM=hawky.ai@gmail.com" \
            "EMAIL_SERVER_HOST=smtp.example.com" \
            "EMAIL_SERVER_PORT=587" \
            "EMAIL_SERVER_USER=hawky.ai@gmail.com" \
            "GOOGLE_CLIENT_ID=896125824463-ru2dhbl8mtscj928kagc8346cl681k0b.apps.googleusercontent.com" \
            "NEXTAUTH_URL=https://$CUSTOM_DOMAIN"
    
    - name: üîê Enable Managed Identity
      run: |
        echo "Ensuring Container App has system-assigned managed identity..."
        az containerapp identity assign \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --system-assigned \
          2>&1 || true
        
        echo "‚úÖ Managed identity enabled"
    
    - name: üîç Get Managed Identity Principal ID
      id: get-identity
      run: |
        echo "Retrieving Container App managed identity..."
        
        PRINCIPAL_ID=$(az containerapp identity show \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query principalId -o tsv 2>/dev/null)
        
        if [ -z "$PRINCIPAL_ID" ]; then
          echo "‚è≥ Principal ID not immediately available, waiting 10 seconds..."
          sleep 10
          
          PRINCIPAL_ID=$(az containerapp identity show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --query principalId -o tsv)
        fi
        
        if [ -z "$PRINCIPAL_ID" ]; then
          echo "‚ùå CRITICAL ERROR: Cannot retrieve Principal ID"
          exit 1
        fi
        
        echo "‚úÖ Container App Managed Identity: $PRINCIPAL_ID"
        echo "PRINCIPAL_ID=$PRINCIPAL_ID" >> $GITHUB_OUTPUT
        echo ""
        echo "‚ö†Ô∏è IMPORTANT: An Azure admin needs to manually grant Key Vault access!"
        echo "Run this command as an admin with proper permissions:"
        echo ""
        echo "az role assignment create \\"
        echo "  --role 'Key Vault Secrets User' \\"
        echo "  --assignee-object-id $PRINCIPAL_ID \\"
        echo "  --assignee-principal-type ServicePrincipal \\"
        echo "  --scope /subscriptions/$SUBSCRIPTION_ID/resourceGroups/mongodb-prod-rg/providers/Microsoft.KeyVault/vaults/$KV_NAME"
        echo ""
    
    - name: ‚ö†Ô∏è Manual Permission Required
      run: |
        PRINCIPAL_ID="${{ steps.get-identity.outputs.PRINCIPAL_ID }}"
        
        echo "================================================"
        echo "‚ö†Ô∏è  MANUAL ACTION REQUIRED"
        echo "================================================"
        echo ""
        echo "Your GitHub Actions service principal doesn't have"
        echo "permission to assign RBAC roles on the Key Vault."
        echo ""
        echo "An Azure administrator needs to run ONE of these:"
        echo ""
        echo "Option 1: Grant via Azure CLI"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "az role assignment create \\"
        echo "  --role 'Key Vault Secrets User' \\"
        echo "  --assignee-object-id $PRINCIPAL_ID \\"
        echo "  --assignee-principal-type ServicePrincipal \\"
        echo "  --scope /subscriptions/$SUBSCRIPTION_ID/resourceGroups/mongodb-prod-rg/providers/Microsoft.KeyVault/vaults/$KV_NAME"
        echo ""
        echo "Option 2: Grant via Azure Portal"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "1. Go to: Key Vault 'kvhawkyai'"
        echo "2. Click: Access control (IAM)"
        echo "3. Click: + Add ‚Üí Add role assignment"
        echo "4. Select: Key Vault Secrets User"
        echo "5. Search for: ca-hawkyai-labs"
        echo "6. Assign the role"
        echo ""
        echo "Principal ID: $PRINCIPAL_ID"
        echo ""
        echo "After granting permission:"
        echo "1. Wait 2-3 minutes for RBAC to propagate"
        echo "2. Re-run this workflow"
        echo "3. It will succeed!"
        echo ""
        echo "================================================"
        
        # Save to summary
        echo "## ‚ö†Ô∏è Manual Action Required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your GitHub service principal lacks permission to assign RBAC roles." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**An Azure admin must run this command:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "az role assignment create \\" >> $GITHUB_STEP_SUMMARY
        echo "  --role 'Key Vault Secrets User' \\" >> $GITHUB_STEP_SUMMARY
        echo "  --assignee-object-id $PRINCIPAL_ID \\" >> $GITHUB_STEP_SUMMARY
        echo "  --assignee-principal-type ServicePrincipal \\" >> $GITHUB_STEP_SUMMARY
        echo "  --scope /subscriptions/$SUBSCRIPTION_ID/resourceGroups/mongodb-prod-rg/providers/Microsoft.KeyVault/vaults/$KV_NAME" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Principal ID:** \`$PRINCIPAL_ID\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "After granting permission, wait 2-3 minutes and re-run this workflow." >> $GITHUB_STEP_SUMMARY
    
    - name: ‚è∏Ô∏è Waiting for Manual Permission Grant
      run: |
        echo "================================================"
        echo "Pausing deployment..."
        echo "================================================"
        echo ""
        echo "This workflow will now exit."
        echo "After the admin grants permission, re-run this workflow."
        echo ""
        echo "The Container App is created, but secrets aren't configured yet."
        echo ""
        exit 1