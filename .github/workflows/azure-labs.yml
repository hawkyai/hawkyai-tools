name: Deploy to Labs

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: acrhawkyai
  RESOURCE_GROUP: rg-hawkyai-staging
  CONTAINER_APP_NAME: ca-hawkyai-labs
  CONTAINER_APP_ENV: cae-hawkyai-staging
  IMAGE_NAME: hawkyai-labs
  KV_NAME: kvhawkyai
  SUBSCRIPTION_ID: 192d2bcd-429c-42f5-811b-48a95f8c506f
  CUSTOM_DOMAIN: labs.hawky.ai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸŽ¯ Set Azure Subscription
      run: |
        az account set --subscription $SUBSCRIPTION_ID
        az account show
        echo "âœ… Subscription set to: $SUBSCRIPTION_ID"
    
    - name: ðŸ³ Build and push to ACR
      run: |
        az acr build \
          --registry $ACR_NAME \
          --image $IMAGE_NAME:${{ github.sha }} \
          --image $IMAGE_NAME:latest \
          --file Dockerfile \
          .
    
    - name: ðŸš€ Create Container App (first deployment)
      continue-on-error: true
      run: |
        az containerapp create \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --environment $CONTAINER_APP_ENV \
          --image $ACR_NAME.azurecr.io/$IMAGE_NAME:latest \
          --target-port 3000 \
          --ingress external \
          --registry-server $ACR_NAME.azurecr.io \
          --registry-username acrhawkyai \
          --registry-password "${{ secrets.ACR_PASSWORD }}" \
          --cpu 1.0 \
          --memory 2.0Gi \
          --min-replicas 2 \
          --max-replicas 5 \
          --env-vars \
            "NODE_ENV=production" \
            "MONGODB_DB=hawkyai" \
            "AWS_REGION=ap-south-1" \
            "AWS_S3_BUCKET=hawky-ai-static-tryout" \
            "ELASTICSEARCH_CLOUD_ID=h-staging-ES:Y2VudHJhbGluZGlhLmF6dXJlLmVsYXN0aWMtY2xvdWQuY29tOjkyNDMkYjA5NWRmNDQ1OWQxNGUwMWI3MjMwMDU3ZjkwNTNhZTYkMmYzNjJkZTkyNWRjNDAzMGJiODU5NzFmNGFkZDA0ODQ=" \
            "ELASTICSEARCH_IMAGE_INDEX=image_competitors_analysis" \
            "ELASTICSEARCH_VIDEO_INDEX=video_competitors_analysis" \
            "EMAIL_FROM=hawky.ai@gmail.com" \
            "EMAIL_SERVER_HOST=smtp.example.com" \
            "EMAIL_SERVER_PORT=587" \
            "EMAIL_SERVER_USER=hawky.ai@gmail.com" \
            "GOOGLE_CLIENT_ID=896125824463-ru2dhbl8mtscj928kagc8346cl681k0b.apps.googleusercontent.com" \
            "NEXTAUTH_URL=https://$CUSTOM_DOMAIN"
    
    - name: ðŸ” Enable Managed Identity
      continue-on-error: true
      run: |
        az containerapp identity assign \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --system-assigned
    
    - name: ðŸ” Get Managed Identity Details
      id: get-identity
      run: |
        PRINCIPAL_ID=$(az containerapp identity show \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query principalId -o tsv)
        
        if [ -z "$PRINCIPAL_ID" ]; then
          echo "âŒ ERROR: Failed to retrieve Principal ID"
          echo "Attempting to re-enable managed identity..."
          az containerapp identity assign \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --system-assigned
          
          sleep 10
          
          PRINCIPAL_ID=$(az containerapp identity show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --query principalId -o tsv)
        fi
        
        if [ -z "$PRINCIPAL_ID" ]; then
          echo "âŒ CRITICAL ERROR: Cannot retrieve Principal ID"
          exit 1
        fi
        
        echo "âœ… Principal ID: $PRINCIPAL_ID"
        echo "PRINCIPAL_ID=$PRINCIPAL_ID" >> $GITHUB_OUTPUT
    
    - name: ðŸ” Check Key Vault Configuration
      id: check-kv
      run: |
        echo "Checking Key Vault configuration..."
        
        # Check if Key Vault exists
        KV_EXISTS=$(az keyvault list --query "[?name=='$KV_NAME'].name" -o tsv)
        if [ -z "$KV_EXISTS" ]; then
          echo "âŒ ERROR: Key Vault '$KV_NAME' not found"
          exit 1
        fi
        echo "âœ… Key Vault found: $KV_NAME"
        
        # Get Key Vault resource ID
        KV_ID=$(az keyvault show --name $KV_NAME --query id -o tsv)
        echo "Key Vault ID: $KV_ID"
        echo "KV_ID=$KV_ID" >> $GITHUB_OUTPUT
        
        # Check authorization model
        KV_RBAC=$(az keyvault show --name $KV_NAME --query "properties.enableRbacAuthorization" -o tsv)
        echo "RBAC Enabled: $KV_RBAC"
        echo "KV_RBAC=$KV_RBAC" >> $GITHUB_OUTPUT
        
        # List secrets to verify access from pipeline
        echo "Listing secrets in Key Vault..."
        az keyvault secret list --vault-name $KV_NAME --query "[].name" -o table
    
    - name: ðŸ”‘ Grant Key Vault Access (Access Policy Model)
      if: steps.check-kv.outputs.KV_RBAC == 'false' || steps.check-kv.outputs.KV_RBAC == ''
      run: |
        echo "Using Access Policy model..."
        PRINCIPAL_ID="${{ steps.get-identity.outputs.PRINCIPAL_ID }}"
        
        echo "Setting access policy for Principal ID: $PRINCIPAL_ID"
        
        # Remove the error suppression to see actual errors
        az keyvault set-policy \
          --name $KV_NAME \
          --object-id $PRINCIPAL_ID \
          --secret-permissions get list
        
        echo "âœ… Access policy set successfully"
        
        # Verify the policy was set
        echo "Verifying access policy..."
        POLICY_COUNT=$(az keyvault show --name $KV_NAME \
          --query "properties.accessPolicies[?objectId=='$PRINCIPAL_ID'] | length(@)" -o tsv)
        
        if [ "$POLICY_COUNT" -eq "0" ]; then
          echo "âŒ ERROR: Access policy was not set properly"
          exit 1
        fi
        
        echo "âœ… Access policy verified ($POLICY_COUNT policies found)"
    
    - name: ðŸ”‘ Grant Key Vault Access (RBAC Model)
      if: steps.check-kv.outputs.KV_RBAC == 'true'
      run: |
        echo "Using RBAC model..."
        PRINCIPAL_ID="${{ steps.get-identity.outputs.PRINCIPAL_ID }}"
        KV_ID="${{ steps.check-kv.outputs.KV_ID }}"
        
        echo "Assigning 'Key Vault Secrets User' role to Principal ID: $PRINCIPAL_ID"
        
        # Try to create role assignment
        az role assignment create \
          --role "Key Vault Secrets User" \
          --assignee-object-id $PRINCIPAL_ID \
          --assignee-principal-type ServicePrincipal \
          --scope $KV_ID \
          2>&1 | tee /tmp/role-assignment.log || true
        
        # Check if it succeeded or already exists
        if grep -q "role assignment already exists" /tmp/role-assignment.log || \
           grep -q "Conflict" /tmp/role-assignment.log; then
          echo "âœ… Role assignment already exists"
        else
          echo "âœ… Role assignment created"
        fi
        
        # Verify the role assignment
        echo "Verifying role assignment..."
        ROLE_COUNT=$(az role assignment list \
          --assignee $PRINCIPAL_ID \
          --scope $KV_ID \
          --query "length([?roleDefinitionName=='Key Vault Secrets User'])" -o tsv)
        
        if [ "$ROLE_COUNT" -eq "0" ]; then
          echo "âŒ ERROR: Role assignment was not set properly"
          exit 1
        fi
        
        echo "âœ… Role assignment verified"
    
    - name: â³ Wait for Permission Propagation
      run: |
        echo "â³ Waiting 90 seconds for Azure AD and Key Vault permissions to propagate..."
        echo "This is necessary because Azure's permission system can take time to sync."
        for i in {90..1}; do
          echo -ne "Waiting: $i seconds remaining...\r"
          sleep 1
        done
        echo "âœ… Wait complete"
    
    - name: ðŸ§ª Verify Key Vault Access from Managed Identity
      run: |
        PRINCIPAL_ID="${{ steps.get-identity.outputs.PRINCIPAL_ID }}"
        
        echo "Testing Key Vault access..."
        echo "Principal ID: $PRINCIPAL_ID"
        
        # Try to list secrets
        echo "Attempting to list secrets..."
        az keyvault secret list --vault-name $KV_NAME --query "[].name" -o table
        
        # Try to read a specific secret
        echo "Attempting to read MONGODB-URI secret..."
        SECRET_EXISTS=$(az keyvault secret show \
          --vault-name $KV_NAME \
          --name MONGODB-URI \
          --query "name" -o tsv 2>/dev/null || echo "NOT_FOUND")
        
        if [ "$SECRET_EXISTS" == "NOT_FOUND" ]; then
          echo "âš ï¸ WARNING: Could not read MONGODB-URI secret"
          echo "This could be normal if the secret doesn't exist"
        else
          echo "âœ… Successfully accessed secret: $SECRET_EXISTS"
        fi
    
    - name: ðŸ” Add Secrets from Key Vault
      run: |
        echo "Setting Container App secrets with Key Vault references..."
        
        az containerapp secret set \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --secrets \
            mongodb-uri=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/MONGODB-URI,identityref:system \
            aws-access-key-id=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/AWS-ACCESS-KEY-ID,identityref:system \
            aws-secret-access-key=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/AWS-SECRET-ACCESS-KEY,identityref:system \
            elasticsearch-api-key=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ELASTICSEARCH-API-KEY,identityref:system \
            google-client-secret=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/GOOGLE-CLIENT-SECRET,identityref:system \
            nextauth-secret=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/NEXTAUTH-SECRET,identityref:system \
            resend-api-key=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/RESEND-API-KEY,identityref:system \
            email-server-password=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/EMAIL-SERVER-PASSWORD,identityref:system \
            slack-error-webhook-url=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/SLACK-ERROR-WEBHOOK-URL,identityref:system \
            slack-webhook-url=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/SLACK-WEBHOOK-URL,identityref:system \
            vercel-oidc-token=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/VERCEL-OIDC-TOKEN,identityref:system \
            zoho-access-token=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-ACCESS-TOKEN,identityref:system \
            zoho-client-id=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-CLIENT-ID,identityref:system \
            zoho-client-secret=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-CLIENT-SECRET,identityref:system \
            zoho-refresh-token=keyvaultref:https://$KV_NAME.vault.azure.net/secrets/ZOHO-REFRESH-TOKEN,identityref:system
        
        echo "âœ… Secrets configured successfully"
    
    - name: ðŸ”„ Update Container App
      run: |
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} \
          --set-env-vars \
            "MONGODB_URI=secretref:mongodb-uri" \
            "AWS_ACCESS_KEY_ID=secretref:aws-access-key-id" \
            "AWS_SECRET_ACCESS_KEY=secretref:aws-secret-access-key" \
            "ELASTICSEARCH_API_KEY=secretref:elasticsearch-api-key" \
            "GOOGLE_CLIENT_SECRET=secretref:google-client-secret" \
            "NEXTAUTH_SECRET=secretref:nextauth-secret" \
            "RESEND_API_KEY=secretref:resend-api-key" \
            "EMAIL_SERVER_PASSWORD=secretref:email-server-password" \
            "SLACK_ERROR_WEBHOOK_URL=secretref:slack-error-webhook-url" \
            "SLACK_WEBHOOK_URL=secretref:slack-webhook-url" \
            "VERCEL_OIDC_TOKEN=secretref:vercel-oidc-token" \
            "ZOHO_ACCESS_TOKEN=secretref:zoho-access-token" \
            "ZOHO_CLIENT_ID=secretref:zoho-client-id" \
            "ZOHO_CLIENT_SECRET=secretref:zoho-client-secret" \
            "ZOHO_REFRESH_TOKEN=secretref:zoho-refresh-token" \
            "NEXTAUTH_URL=https://$CUSTOM_DOMAIN"
    
    - name: ðŸ”€ Enable Multiple Revisions
      run: |
        az containerapp revision set-mode \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --mode multiple
    
    - name: ðŸŒ Configure Custom Domain
      run: |
        DOMAIN_EXISTS=$(az containerapp hostname list \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query "[?name=='$CUSTOM_DOMAIN'].name" -o tsv)
        
        if [ -z "$DOMAIN_EXISTS" ]; then
          echo "âž• Adding custom domain: $CUSTOM_DOMAIN"
          az containerapp hostname add \
            --hostname $CUSTOM_DOMAIN \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP
          
          az containerapp hostname bind \
            --hostname $CUSTOM_DOMAIN \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --environment $CONTAINER_APP_ENV \
            --validation-method CNAME
        else
          echo "âœ… Custom domain already configured"
        fi
    
    - name: âœ… Deployment Summary
      run: |
        echo "### ðŸŽ‰ Labs Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** Labs" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** [labs.hawky.ai](https://$CUSTOM_DOMAIN)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image:** \`$ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY